name: talon_win_normalize_createservice
description: Normalizes event fields using conditional logic to standardize values across different event sources.
visualization:
  options:
    columns:
    - fieldName: '@timestamp'
      format: datetime
      type: field
      width: 200
    - groupByPrefix: false
      header: Field List
      type: fieldList
    newestAtBottom: true
    showOnlyFirstLine: false
  type: list-view
labels:
- talon_hunt_framework
- normalize
- bitmask
- case
- createservice
- windows
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // NORMALIZATION
  // =====================================================
  | case {
      ServiceStart = "0" | ServiceStart := "SERVICE_BOOT_START"   ;
      ServiceStart = "1" | ServiceStart := "SERVICE_SYSTEM_START" ;
      ServiceStart = "2" | ServiceStart := "SERVICE_AUTO_START"   ;
      ServiceStart = "3" | ServiceStart := "SERVICE_DEMAND_START" ;
      ServiceStart = "4" | ServiceStart := "SERVICE_DISABLED"     ;
  * }

  | case {
      ServiceErrorControl = "0" | ServiceErrorControl := "SERVICE_ERROR_IGNORE"   ;
      ServiceErrorControl = "1" | ServiceErrorControl := "SERVICE_ERROR_NORMAL"   ;
      ServiceErrorControl = "2" | ServiceErrorControl := "SERVICE_ERROR_SEVERE"   ;
      ServiceErrorControl = "3" | ServiceErrorControl := "SERVICE_ERROR_CRITICAL" ;
  * }

  | case {
      ServiceType = "1"   | ServiceType := "SERVICE_KERNEL_DRIVER"        ;
      ServiceType = "2"   | ServiceType := "SERVICE_FILE_SYSTEM_DRIVER"   ;
      ServiceType = "4"   | ServiceType := "SERVICE_ADAPTER"              ;
      ServiceType = "8"   | ServiceType := "SERVICE_RECOGNIZER_DRIVER"    ;
      ServiceType = "16"  | ServiceType := "SERVICE_WIN32_OWN_PROCESS"    ;
      ServiceType = "32"  | ServiceType := "SERVICE_WIN32_SHARE_PROCESS"  ;
      ServiceType = "256" | ServiceType := "SERVICE_INTERACTIVE_PROCESS"  ;
  * }

  | case {
      ServiceServiceSidType = "0" | ServiceServiceSidType := "SERVICE_SID_TYPE_NONE"         ;
      ServiceServiceSidType = "1" | ServiceServiceSidType := "SERVICE_SID_TYPE_UNRESTRICTED" ;
      ServiceServiceSidType = "3" | ServiceServiceSidType := "SERVICE_TYPE_RESTRICTED"       ;
  * }

  | case {
      ServiceStart = "0" | ServiceStart := "SERVICE_BOOT_START"   ;
      ServiceStart = "1" | ServiceStart := "SERVICE_SYSTEM_START" ;
      ServiceStart = "2" | ServiceStart := "SERVICE_AUTO_START"   ;
      ServiceStart = "3" | ServiceStart := "SERVICE_DEMAND_START" ;
      ServiceStart = "4" | ServiceStart := "SERVICE_DISABLED"     ;
  * }

  | case {
      ServiceErrorControl = "0" | ServiceErrorControl := "SERVICE_ERROR_IGNORE"   ;
      ServiceErrorControl = "1" | ServiceErrorControl := "SERVICE_ERROR_NORMAL"   ;
      ServiceErrorControl = "2" | ServiceErrorControl := "SERVICE_ERROR_SEVERE"   ;
      ServiceErrorControl = "3" | ServiceErrorControl := "SERVICE_ERROR_CRITICAL" ;
  * }

  | case {
      ServiceType = "1"   | ServiceType := "SERVICE_KERNEL_DRIVER"        ;
      ServiceType = "2"   | ServiceType := "SERVICE_FILE_SYSTEM_DRIVER"   ;
      ServiceType = "4"   | ServiceType := "SERVICE_ADAPTER"              ;
      ServiceType = "8"   | ServiceType := "SERVICE_RECOGNIZER_DRIVER"    ;
      ServiceType = "16"  | ServiceType := "SERVICE_WIN32_OWN_PROCESS"    ;
      ServiceType = "32"  | ServiceType := "SERVICE_WIN32_SHARE_PROCESS"  ;
      ServiceType = "256" | ServiceType := "SERVICE_INTERACTIVE_PROCESS"  ;
  * }

  | case {
      ServiceServiceSidType = "0" | ServiceServiceSidType := "SERVICE_SID_TYPE_NONE"         ;
      ServiceServiceSidType = "1" | ServiceServiceSidType := "SERVICE_SID_TYPE_UNRESTRICTED" ;
      ServiceServiceSidType = "3" | ServiceServiceSidType := "SERVICE_TYPE_RESTRICTED"       ;
  * }

  //CREATE NORMALIZATION FIELD
  | NormalizedServiceDisplayName := ServiceDisplayName
  | NormalizedServiceImagePath := ServiceImagePath

  //LOWERCASE SERVICE DISPLAY NAME
  | lowercase(field=["NormalizedServiceDisplayName","NormalizedServiceImagePath"])

  //SERVICEIMAGEPATH NORMALIZATION
  | replace(regex="[0-9\\.\\-\\_]{3,}", with="",field=NormalizedServiceImagePath)
  | replace(regex="DX[A-Z0-9]{3,4}\\.tmp", with="",field=NormalizedServiceImagePath)
  | replace(regex="7z[A-Z0-9]{3,5}\\.tmp", with="",field=NormalizedServiceImagePath)
  | replace(regex="\\{[0-9a-fA-F\\-]{10,40}\\}", with="temp-guid",field=NormalizedServiceImagePath)
  | replace(regex="[cC]:\\\\[uU][sS][eE][rR][sS]\\\\[a-zA-Z0-9\\.\\-\\_\\$~]+\\\\", with="C:\\\\users\\\\user\\\\",field=NormalizedServiceImagePath)
  | replace(regex="\\\\\\?\\?\\\\", with="",field=NormalizedServiceImagePath)
  | replace(regex="\"", with="",field=NormalizedServiceImagePath)
  | replace(regex="\\\\\\\\", with="\\\\",field=NormalizedServiceImagePath)
  | replace(regex="bomgar\\-scc\\-0x\\w+", with="bomgar\\-scc",field=NormalizedServiceImagePath)

  //SERVICEDISPLAYNAME NORMALIZATION
  | replace(regex="(-S-1-5-.*)|\\{[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}\\}", with="",field=NormalizedServiceDisplayName)
  | replace(regex="\\{[0-9a-fA-F\\-]{10,40}\\}", with="temp-guid",field=NormalizedServiceDisplayName)
  | replace(regex="[0-9\\.\\-\\_]{3,}", with="",field=NormalizedServiceDisplayName)
  | replace(regex="\\(.*\\)", with="",field=NormalizedServiceDisplayName)
