name: talon_win_normalize_classifiedmoduleload
description: Normalizes event fields using conditional logic to standardize values across different event sources.
visualization:
  options:
    columns:
    - fieldName: '@timestamp'
      format: datetime
      type: field
      width: 200
    - groupByPrefix: false
      header: Field List
      type: fieldList
    newestAtBottom: true
    showOnlyFirstLine: false
  type: list-view
labels:
- talon_hunt_framework
- asset
- normalize
- classifiedmoduleload
- windows
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // NORMALIZATION
  // =====================================================
  | case {
      MappedFromUserMode = "0" | MappedFromUserMode := "KERNEL";
      MappedFromUserMode > "0" | MappedFromUserMode := "USER";
      *
  }

  | case {
      ImageSignatureType = "0" | ImageSignatureType := "NONE";
      ImageSignatureType = "1" | ImageSignatureType := "EMBEDDED";
      ImageSignatureType = "2" | ImageSignatureType := "CACHE";
      ImageSignatureType = "3" | ImageSignatureType := "CATALOG_CACHED";
      ImageSignatureType = "4" | ImageSignatureType := "CATALOG_NOT_CACHED";
      ImageSignatureType = "5" | ImageSignatureType := "CATALOG_HINT";
      ImageSignatureType = "6" | ImageSignatureType := "PACKAGE_CATALOG";
      ImageSignatureType = "7" | ImageSignatureType := "PPL_MITIGATED";
      *
  }

  | case {
      ImageSignatureLevel = "0"  | ImageSignatureLevel := "UNCHECKED";
      ImageSignatureLevel = "1"  | ImageSignatureLevel := "UNSIGNED";
      ImageSignatureLevel = "2"  | ImageSignatureLevel := "ENTERPRISE";
      ImageSignatureLevel = "3"  | ImageSignatureLevel := "CUSTOM1";
      ImageSignatureLevel = "4"  | ImageSignatureLevel := "AUTHENTICODE";
      ImageSignatureLevel = "5"  | ImageSignatureLevel := "CUSTOM2";
      ImageSignatureLevel = "6"  | ImageSignatureLevel := "STORE";
      ImageSignatureLevel = "7"  | ImageSignatureLevel := "ANTIMALWARE";
      ImageSignatureLevel = "8"  | ImageSignatureLevel := "MICROSOFT";
      ImageSignatureLevel = "9"  | ImageSignatureLevel := "CUSTOM4";
      ImageSignatureLevel = "10" | ImageSignatureLevel := "CUSTOM5";
      ImageSignatureLevel = "11" | ImageSignatureLevel := "DYNAMICCODEGEN";
      ImageSignatureLevel = "12" | ImageSignatureLevel := "WINDOWS";
      ImageSignatureLevel = "13" | ImageSignatureLevel := "WINDOWSPROTECTEDPROCESSLIGHT";
      ImageSignatureLevel = "14" | ImageSignatureLevel := "WINDOWSTCB";
      ImageSignatureLevel = "15" | ImageSignatureLevel := "CUSTOM6";
      *
  }

  | bitfield:extractFlagsAsString(
      field="ModuleLoadTelemetryClassification",
      flagNames=[
          [0,  "FIRST_LOAD"],
          [1,  "RUNDLL32_TARGET"],
          [2,  "DETECT_TREE"],
          [3,  "MAPPED_FROM_KERNEL_MODE"],
          [4,  "UNUSUAL_EXTENSION"],
          [5,  "MOTW"],
          [6,  "SIGN_INFO_CONTINUITY"],
          [7,  "CLOUD_ALL"],
          [8,  "ORIGINAL_FILENAME_MISMATCH"],
          [9,  "REMOVABLE_MEDIA"],
          [10, "DATA_EXTENSION"],
          [11, "SYNTHETIC_LOAD"],
          [12, "CLOUDY_REQUEST"]
      ],
      as="ModuleLoadTelemetryClassification_mask",
      separator=", "
  )

  | bitfield:extractFlagsAsString(
      field="ModuleCharacteristics",
      flagNames=[
          [0,  "RELOCS_STRIPPED"],
          [1,  "EXECUTABLE_IMAGE"],
          [2,  "LINE_NUMS_STRIPPED"],
          [3,  "LOCAL_SYMS_STRIPPED"],
          [4,  "AGGRESSIVE_WS_TRIM"],
          [5,  "LARGE_ADDRESS_AWARE"],
          [6,  "BYTES_RESERVED_LO"],
          [7,  "_32BIT_MACHINE"],
          [8,  "DEBUG_STRIPPED"],
          [9,  "REMOVABLE_RUN_FROM_SWAP"],
          [10, "NET_RUN_FROM_SWAP"],
          [11, "FILE_SYSTEM"],
          [12, "FILE_DLL"],
          [13, "UP_SYSTEM_ONLY"],
          [14, "BYTES_RESERVED_HI"]
      ],
      as="ModuleCharacteristics_mask",
      separator=", "
  )

  | bitfield:extractFlagsAsString(
      field="SignInfoFlags",
      flagNames=[
          [0,  "SIGNATURE_FLAG_SELF_SIGNED"],
          [1,  "SIGNATURE_FLAG_MS_SIGNED"],
          [2,  "SIGNATURE_FLAG_TEST_SIGNED"],
          [3,  "SIGNATURE_FLAG_MS_CROSS_SIGNED"],
          [4,  "SIGNATURE_FLAG_CAT_SIGNED"],
          [5,  "SIGNATURE_FLAG_DRM_SIGNED"],
          [6,  "SIGNATURE_FLAG_DRM_TEST_SIGNED"],
          [7,  "SIGNATURE_FLAG_MS_CAT_SIGNED"],
          [8,  "SIGNATURE_FLAG_CATALOGS_RELOADED"],
          [9,  "SIGNATURE_FLAG_NO_SIGNATURE"],
          [10, "SIGNATURE_FLAG_INVALID_SIGN_CHAIN"],
          [11, "SIGNATURE_FLAG_SIGN_HASH_MISMATCH"],
          [12, "SIGNATURE_FLAG_NO_CODE_KEY_USAGE"],
          [13, "SIGNATURE_FLAG_NO_PAGE_HASHES"],
          [14, "SIGNATURE_FLAG_FAILED_CERT_CHECK"],
          [15, "SIGNATURE_FLAG_NO_EMBEDDED_CERT"],
          [16, "SIGNATURE_FLAG_FAILED_COPY_KEYS"],
          [17, "SIGNATURE_FLAG_UNKNOWN_ERROR"],
          [18, "SIGNATURE_FLAG_HAS_VALID_SIGNATURE"],
          [19, "SIGNATURE_FLAG_EMBEDDED_SIGNED"],
          [20, "SIGNATURE_FLAG_3RD_PARTY_ROOT"],
          [21, "SIGNATURE_FLAG_TRUSTED_BOOT_ROOT"],
          [22, "SIGNATURE_FLAG_UEFI_ROOT"],
          [23, "SIGNATURE_FLAG_PRS_WIN81_ROOT"],
          [24, "SIGNATURE_FLAG_FLIGHT_ROOT"],
          [25, "SIGNATURE_FLAG_APPLE_SIGNED"],
          [26, "SIGNATURE_FLAG_ESBCACHE"],
          [27, "SIGNATURE_FLAG_NO_CACHED_DATA"],
          [28, "SIGNATURE_FLAG_CERT_EXPIRED"],
          [29, "SIGNATURE_FLAG_CERT_REVOKED"],
          [30, "SIGNATURE_FLAG_MS_ISSUED_3RD_PARTY"]
      ],
      as="SignInfoFlags_mask",
      separator=", "
  )
