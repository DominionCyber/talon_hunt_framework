name: talon_hunt_service_binary_user_controlled_folder
description: Detects the setting of the "ImagePath" value of a service registry key to a path controlled by a non-administrator user such as AppData or ProgramData. Attackers use these directories for persistence or privilege escalation via service hijacking. Adapted from Sigma rule 277dc340-0540-42e7-8efb-5ff460045e07.
visualization:
  options:
    cell-overflow: wrap-text
    column-overflow: truncate
    configured-columns: {}
    row-numbers-enabled: false
  type: table-view
labels:
- talon_hunt_framework
- hunt
- asepvalueupdate
- windows
- threat_hunt
- defense_evasion
- persistence
- t1112
- sigma
- high_signal
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // SEARCH
  // =====================================================
  #event_simpleName=AsepValueUpdate event_platform=Win
  | RegObjectName=/ControlSet/i RegObjectName=/\\Services\\/i
  | RegValueName=/ImagePath/i
  // Service ImagePath registry modification: ControlSet*\Services\*\ImagePath - defines the executable path for Windows services
  | RegStringValue=/(\\ProgramData\\|\\AppData\\Local\\|\\AppData\\Roaming\\)/i
  // User-controlled paths: ProgramData, AppData\Local, AppData\Roaming - writable by non-admin users, common malware staging locations for service persistence/privesc
  | RegObjectName!=/\\Services\\ZoomCptService/i RegStringValue!=/\\Program\sFiles\\Common\sFiles\\Zoom\\Support\\CptService\.exe/i
  // Exclude Zoom legitimate service installation
  | RegObjectName!=/\\Services\\MBAMInstallerService/i RegStringValue!=/\\Users\\/i RegStringValue!=/AppData\\Local\\Temp\\MBAMInstallerService\.exe/i
  // Exclude Malwarebytes installer service
  | (RegObjectName!=/\\Services\\WinDefend\\/i OR RegObjectName!=/\\Services\\MpKs/i) RegStringValue!=/\\ProgramData\\Microsoft\\Windows\sDefender\\/i
  // Exclude Windows Defender services writing to their legitimate ProgramData folder

  // =====================================================
  // SEARCH ASSETS
  // =====================================================
  | $talon_convert_time_utc()
  | $talon_utility_falcon_helper()
  | $talon_win_normalize_asepvalueupdate()

  // =====================================================
  // TABLE
  // =====================================================
  | table(
      [
          utc_time,
          ComputerName,
          UserName,
          RegObjectName,
          RegStringValue,
          RegValueName,
          RegType,
          AsepClass,
          AsepFlags,
          AsepValueType
      ],
      limit=max
  )
