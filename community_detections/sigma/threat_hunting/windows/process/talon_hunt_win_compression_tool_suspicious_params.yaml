name: talon_hunt_compression_tool_suspicious_params
description: Detects potentially suspicious command line arguments of common data compression tools like 7zip and RAR. Flags include password protection, date filtering, and secure deletion which are commonly used for data staging and exfiltration. Adapted from Sigma rule 27a72a60-7e5e-47b1-9d17-909c9abafdcd.
visualization:
  options:
  cell-overflow: wrap-text
  column-overflow: truncate
  configured-columns: {}
  row-numbers-enabled: false
  type: table-view
labels:
- talon_hunt_framework
- hunt
- processrollup2
- syntheticprocessrollup2
- windows
- threat_hunt
- collection
- t1560.001
- sigma
- medium_signal
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // SEARCH
  // =====================================================
  #event_simpleName=/ProcessRollup2/ event_platform=Win 
  | OriginalFilename=/7z.*\.exe/i OR OriginalFilename=/.*rar\.exe/i OR OriginalFilename=/.*Command.*Line.*RAR.*/i OR FileName=/7z.*\.exe/i OR FileName=/.*rar\.exe/i OR FileName=/.*Command.*Line.*RAR.*/i
  // 7zip/RAR compression tools: legitimate archivers commonly abused for staging data before exfil
  | CommandLine=/(\s\-p|\s\-ta|\s\-tb|\s\-sdel|\s\-dw|\s\-hp)/i
  // Suspicious flags: -p/-hp (password/header encryption), -ta/-tb (date filtering for targeted collection), -sdel/-dw (secure delete source files to cover tracks)
  | FilePath!=/(\:\\Program\sFiles\\|\:\\Program\sFiles\s\(x86\)\\)/i
  // Exclude compression tools launched from legitimate installed applications

  // =====================================================
  // SEARCH ASSETS
  // =====================================================
  | $talon_convert_time_utc()
  | $talon_utility_falcon_helper()
  | $talon_win_format_callstackmodules()
  | $talon_win_normalize_file_path(TargetField=FilePath)
  | $talon_win_normalize_file_path(TargetField=CallStackModules)
  | $talon_win_normalize_nt_authority_system_user()
  | $talon_win_normalize_processrollup2()

  // =====================================================
  // TABLE
  // =====================================================
  | table(
      [
          utc_time,
          ComputerName,
          UserName,
          GrandParentBaseFileName,
          ParentBaseFileName,
          FilePath,
          FileName,
          CommandLine,
          SHA256HashData,
          CallStackModules,
          HostUrl,
          RefererUrl,
          OriginalFilename,
          SessionId,
          ImageSubsystem,
          IntegrityLevel,
          CreateProcessType,
          ProcessCreateFlags,
          ProcessCreateFlags_mask,
          ProcessParameterFlags,
          ProcessParameterFlags_mask,
          ProcessSxsFlags,
          ProcessSxsFlags_mask,
          RawProcessId,
          SignInfoFlags,
          SignInfoFlags_mask
      ],
      limit=max
  )
