name: talon_win_normalize_imagehash
description: Normalizes event fields using conditional logic to standardize values across different event sources.
visualization:
  options:
    columns:
    - fieldName: '@timestamp'
      format: datetime
      type: field
      width: 200
    - groupByPrefix: false
      header: Field List
      type: fieldList
    newestAtBottom: true
    showOnlyFirstLine: false
  type: list-view
labels:
- talon_hunt_framework
- asset
- normalize
- imagehash
- windows
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // NORMALIZATION
  // =====================================================
  | case {
      PrimaryModule = "1" | PrimaryModule := "TRUE";
      PrimaryModule = "0" | PrimaryModule := "FALSE";
      *
  }

  | case {
      MappedFromUserMode = "0" | MappedFromUserMode := "KERNEL";
      MappedFromUserMode > "0" | MappedFromUserMode := "USER";
      *
  }

  | case {
      FileKnownStatus = "0" | FileKnownStatus := "FILE_KNOWN";
      FileKnownStatus = "1" | FileKnownStatus := "FILE_UNKNOWN";
      FileKnownStatus = "2" | FileKnownStatus := "UNSURE";
      FileKnownStatus = "3" | FileKnownStatus := "LIGHTNING_TIMEOUT";
      FileKnownStatus = "4" | FileKnownStatus := "SENSOR_OFFLINE";
      FileKnownStatus = "5" | FileKnownStatus := "FILE_EXCLUDED";
      *
  }

  | bitfield:extractFlagsAsString(
      field="ModuleCharacteristics",
      flagNames=[
          [0,  "RELOCS_STRIPPED"],
          [1,  "EXECUTABLE_IMAGE"],
          [2,  "LINE_NUMS_STRIPPED"],
          [3,  "LOCAL_SYMS_STRIPPED"],
          [4,  "AGGRESSIVE_WS_TRIM"],
          [5,  "LARGE_ADDRESS_AWARE"],
          [6,  "BYTES_RESERVED_LO"],
          [7,  "_32BIT_MACHINE"],
          [8,  "DEBUG_STRIPPED"],
          [9,  "REMOVABLE_RUN_FROM_SWAP"],
          [10, "NET_RUN_FROM_SWAP"],
          [11, "FILE_SYSTEM"],
          [12, "FILE_DLL"],
          [13, "UP_SYSTEM_ONLY"],
          [14, "BYTES_RESERVED_HI"]
      ],
      as="ModuleCharacteristics_mask",
      separator=", "
  )

  | bitfield:extractFlagsAsString(
      field="ModuleLoadTelemetryClassification",
      flagNames=[
          [0,  "FIRST_LOAD"],
          [1,  "RUNDLL32_TARGET"],
          [2,  "DETECT_TREE"],
          [3,  "MAPPED_FROM_KERNEL_MODE"],
          [4,  "UNUSUAL_EXTENSION"],
          [5,  "MOTW"],
          [6,  "SIGN_INFO_CONTINUITY"],
          [7,  "CLOUD_ALL"],
          [8,  "ORIGINAL_FILENAME_MISMATCH"],
          [9,  "REMOVABLE_MEDIA"],
          [10, "DATA_EXTENSION"],
          [11, "SYNTHETIC_LOAD"],
          [12, "CLOUDY_REQUEST"]
      ],
      as="ModuleLoadTelemetryClassification_mask",
      separator=", "
  )
