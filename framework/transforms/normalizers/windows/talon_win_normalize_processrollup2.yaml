name: talon_win_normalize_processrollup2
description: Normalizes event fields using conditional logic to standardize values across different event sources.
visualization:
  options:
    columns:
    - fieldName: '@timestamp'
      format: datetime
      type: field
      width: 200
    - groupByPrefix: false
      header: Field List
      type: fieldList
    newestAtBottom: true
    showOnlyFirstLine: false
  type: list-view
labels:
- talon_hunt_framework
- asset
- normalize
- processrollup2
- windows
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // NORMALIZATION
  // =====================================================
  | case {
      ImageSubsystem = "0"   | ImageSubsystem := "IMAGE_SUBSYSTEM_UNKNOWN";
      ImageSubsystem = "1"   | ImageSubsystem := "IMAGE_SUBSYSTEM_NATIVE";
      ImageSubsystem = "2"   | ImageSubsystem := "IMAGE_SUBSYSTEM_WINDOWS_GUI";
      ImageSubsystem = "3"   | ImageSubsystem := "IMAGE_SUBSYSTEM_WINDOWS_CUI";
      ImageSubsystem = "7"   | ImageSubsystem := "IMAGE_SUBSYSTEM_POSIX_CUI";
      ImageSubsystem = "16"  | ImageSubsystem := "IMAGE_SUBSYSTEM_WINDOWS_BOOT_APPLICATION";
      ImageSubsystem = "256" | ImageSubsystem := "IMAGE_SUBSYSTEM_WSL";
      *
  }

  | case {
      IntegrityLevel = "0"     | IntegrityLevel := "UNTRUSTED";
      IntegrityLevel = "4096"  | IntegrityLevel := "LOW";
      IntegrityLevel = "8192"  | IntegrityLevel := "MEDIUM";
      IntegrityLevel = "8448"  | IntegrityLevel := "MEDIUM_PLUS";
      IntegrityLevel = "12288" | IntegrityLevel := "HIGH";
      IntegrityLevel = "16384" | IntegrityLevel := "SYSTEM";
      IntegrityLevel = "20480" | IntegrityLevel := "PROTECTED";
      *
  }

  | case {
      SessionId = "0" | SessionId := "SYSTEM";
      SessionId > "0" | SessionId := "USER";
      *
  }

  | case {
      CreateProcessType = "0" | CreateProcessType := "UNAVAILABLE";
      CreateProcessType = "1" | CreateProcessType := "UNKNOWN";
      CreateProcessType = "2" | CreateProcessType := "NTCREATEPROCESS";
      CreateProcessType = "3" | CreateProcessType := "CREATEPROCESS";
      CreateProcessType = "4" | CreateProcessType := "SHELLEXECUTE";
      CreateProcessType = "5" | CreateProcessType := "CRT_SYSTEM";
      *
  }

  | bitfield:extractFlagsAsString(
      field="ProcessCreateFlags",
      flagNames=[
          [0,  "DEBUG_PROCESS"],
          [1,  "DEBUG_ONLY_THIS_PROCESS"],
          [2,  "CREATE_SUSPENDED"],
          [3,  "DETACHED_PROCESS"],
          [4,  "CREATE_NEW_CONSOLE"],
          [9,  "CREATE_NEW_PROCESS_GROUP"],
          [10, "CREATE_UNICODE_ENVIRONMENT"],
          [11, "CREATE_SEPARATE_WOW_VDM"],
          [12, "CREATE_SHARED_WOW_VDM"],
          [13, "CREATE_FORCEDOS"],
          [16, "INHERIT_PARENT_AFFINITY"],
          [18, "CREATE_PROTECTED_PROCESS"],
          [19, "EXTENDED_STARTUPINFO_PRESENT"],
          [20, "PROCESS_MODE_BACKGROUND_BEGIN"],
          [21, "PROCESS_MODE_BACKGROUND_END"],
          [24, "CREATE_BREAKAWAY_FROM_JOB"],
          [25, "CREATE_PRESERVE_CODE_AUTHZ_LEVEL"],
          [26, "CREATE_DEFAULT_ERROR_MODE"],
          [27, "CREATE_NO_WINDOW"],
          [28, "PROFILE_USER"],
          [29, "PROFILE_KERNEL"],
          [30, "PROFILE_SERVER"],
          [31, "CREATE_IGNORE_SYSTEM_DEFAULT"]
      ],
      as="ProcessCreateFlags_mask",
      separator=", "
  )

  | bitfield:extractFlagsAsString(
      field="ProcessParameterFlags",
      flagNames=[
          [0,  "RTL_USER_PROC_PARAMS_NORMALIZED"],
          [1,  "RTL_USER_PROC_PROFILE_USER"],
          [2,  "RTL_USER_PROC_PROFILE_KERNEL"],
          [3,  "RTL_USER_PROC_PROFILE_SERVER"],
          [5,  "RTL_USER_PROC_RESERVE_1MB"],
          [6,  "RTL_USER_PROC_RESERVE_16MB"],
          [7,  "RTL_USER_PROC_CASE_SENSITIVE"],
          [8,  "RTL_USER_PROC_DISABLE_HEAP_DECOMMIT"],
          [12, "RTL_USER_PROC_DLL_REDIRECTION_LOCAL"],
          [13, "RTL_USER_PROC_APP_MANIFEST_PRESENT"],
          [14, "RTL_USER_PROC_IMAGE_KEY_MISSING"],
          [17, "RTL_USER_PROC_OPTIN_PROCESS"],
          [18, "RTL_USER_PROC_CREATE_NEW_SESSION"],
          [19, "RTL_USER_PROC_USER_CALLBACK_FILTER"],
          [20, "RTL_USER_PROC_DISABLE_LFH_RANDOMIZATION"],
          [21, "RTL_USER_PROC_APPCOMPAT_DLL_REDIRECTION"],
          [22, "RTL_USER_PROC_PROTECTED"]
      ],
      as="ProcessParameterFlags_mask",
      separator=", "
  )

  | bitfield:extractFlagsAsString(
      field="ProcessSxsFlags",
      flagNames=[
          [0, "BASE_SXS_HAS_MANIFEST"],
          [1, "BASE_SXS_HAS_POLICY"],
          [3, "BASE_SXS_HAS_ASSEMBLY"],
          [5, "BASE_SXS_NO_ISOLATION"],
          [6, "BASE_SXS_LOCAL"],
          [8, "BASE_SXS_USING_OVERRIDE_MANIFEST"]
      ],
      as="ProcessSxsFlags_mask",
      separator=", "
  )

  | bitfield:extractFlagsAsString(
      field="SignInfoFlags",
      flagNames=[
          [0,  "SIGNATURE_FLAG_SELF_SIGNED"],
          [1,  "SIGNATURE_FLAG_MS_SIGNED"],
          [2,  "SIGNATURE_FLAG_TEST_SIGNED"],
          [3,  "SIGNATURE_FLAG_MS_CROSS_SIGNED"],
          [4,  "SIGNATURE_FLAG_CAT_SIGNED"],
          [5,  "SIGNATURE_FLAG_DRM_SIGNED"],
          [6,  "SIGNATURE_FLAG_DRM_TEST_SIGNED"],
          [7,  "SIGNATURE_FLAG_MS_CAT_SIGNED"],
          [8,  "SIGNATURE_FLAG_CATALOGS_RELOADED"],
          [9,  "SIGNATURE_FLAG_NO_SIGNATURE"],
          [10, "SIGNATURE_FLAG_INVALID_SIGN_CHAIN"],
          [11, "SIGNATURE_FLAG_SIGN_HASH_MISMATCH"],
          [12, "SIGNATURE_FLAG_NO_CODE_KEY_USAGE"],
          [13, "SIGNATURE_FLAG_NO_PAGE_HASHES"],
          [14, "SIGNATURE_FLAG_FAILED_CERT_CHECK"],
          [15, "SIGNATURE_FLAG_NO_EMBEDDED_CERT"],
          [16, "SIGNATURE_FLAG_FAILED_COPY_KEYS"],
          [17, "SIGNATURE_FLAG_UNKNOWN_ERROR"],
          [18, "SIGNATURE_FLAG_HAS_VALID_SIGNATURE"],
          [19, "SIGNATURE_FLAG_EMBEDDED_SIGNED"],
          [20, "SIGNATURE_FLAG_3RD_PARTY_ROOT"],
          [21, "SIGNATURE_FLAG_TRUSTED_BOOT_ROOT"],
          [22, "SIGNATURE_FLAG_UEFI_ROOT"],
          [23, "SIGNATURE_FLAG_PRS_WIN81_ROOT"],
          [24, "SIGNATURE_FLAG_FLIGHT_ROOT"],
          [25, "SIGNATURE_FLAG_APPLE_SIGNED"],
          [26, "SIGNATURE_FLAG_ESBCACHE"],
          [27, "SIGNATURE_FLAG_NO_CACHED_DATA"],
          [28, "SIGNATURE_FLAG_CERT_EXPIRED"],
          [29, "SIGNATURE_FLAG_CERT_REVOKED"],
          [30, "SIGNATURE_FLAG_MS_ISSUED_3RD_PARTY"]
      ],
      as="SignInfoFlags_mask",
      separator=", "
  )
