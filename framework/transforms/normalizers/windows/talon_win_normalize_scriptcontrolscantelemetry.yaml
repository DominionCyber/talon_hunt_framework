name: talon_win_normalize_scriptcontrolscantelemetry
description: Normalizes event fields using conditional logic to standardize values across different event sources.
visualization:
  options:
    columns:
    - fieldName: '@timestamp'
      format: datetime
      type: field
      width: 200
    - groupByPrefix: false
      header: Field List
      type: fieldList
    newestAtBottom: true
    showOnlyFirstLine: false
  type: list-view
labels:
- talon_hunt_framework
- asset
- normalize
- scriptcontrolscantelemetry
- windows
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // NORMALIZATION
  // =====================================================
  | case {
      HostProcessType = "0" | HostProcessType := "OTHERS";
      HostProcessType = "1" | HostProcessType := "POWERSHELL";
      HostProcessType = "2" | HostProcessType := "POWERSHELL_ISE";
      HostProcessType = "3" | HostProcessType := "WSCRIPT";
      HostProcessType = "4" | HostProcessType := "CSCRIPT";
      HostProcessType = "5" | HostProcessType := "OFFICEEXE";
      *
  }

  | case {
      ScriptingLanguageId = "1" | ScriptingLanguageId := "UNKNOWN";
      ScriptingLanguageId = "2" | ScriptingLanguageId := "POWERSHELL";
      ScriptingLanguageId = "3" | ScriptingLanguageId := "VBA";
      ScriptingLanguageId = "4" | ScriptingLanguageId := "VBSCRIPT";
      ScriptingLanguageId = "5" | ScriptingLanguageId := "JSCRIPT";
      ScriptingLanguageId = "6" | ScriptingLanguageId := "DOTNET";
      ScriptingLanguageId = "7" | ScriptingLanguageId := "EXCEL";
      *
  }

  | bitfield:extractFlagsAsString(
      field="SuspectStackFlag",
      flagNames=[
          [0,  "THREAD_START_NOT_IN_MODULE"],
          [1,  "THREAD_START_IN_NON_IMAGE_FILE"],
          [2,  "INVALID_TEB_STACK_VALUES"],
          [3,  "STACK_POINTER_NOT_IN_STACK"],
          [4,  "BASE_POINTER_NOT_IN_STACK"],
          [5,  "SYSCALL_RETURN_ADDRESS_NOT_IN_NTDLL"],
          [6,  "SYSCALL_RETURN_ADDRESS_ON_STACK"],
          [7,  "STACK_IS_EXECUTABLE"],
          [8,  "RETURN_ADDRESS_NOT_IN_MODULE"],
          [9,  "RETURN_ADDRESS_IN_NON_IMAGE_FILE"],
          [10, "RETURN_ADDRESS_IS_WRITABLE"],
          [11, "ADDRESS_IN_REFLECTIVELY_LOADED_DLL"],
          [12, "ETW_PROVIDED_CALLSTACK"],
          [13, "RETURN_ADDRESS_IN_PRIVATE_IMAGE_MEMORY"]
      ],
      as="SuspectStackFlag_mask",
      separator=", "
  )
