name: talon_win_normalize_lnkfilewritten
description: Normalizes event fields using conditional logic to standardize values across different event sources.
visualization:
  options:
    columns:
    - fieldName: '@timestamp'
      format: datetime
      type: field
      width: 200
    - groupByPrefix: false
      header: Field List
      type: fieldList
    newestAtBottom: true
    showOnlyFirstLine: false
  type: list-view
labels:
- talon_hunt_framework
- asset
- normalize
- lnkfilewritten
- windows
$schema: https://schemas.humio.com/query/v0.6.0
timeInterval:
  isLive: false
  start: 15m
queryString: |-
  // =====================================================
  // NORMALIZATION
  // =====================================================
  | bitfield:extractFlagsAsString(
      field="FileEcpBitmask",
      flagNames=[
          [0, "ECP_SRV_OPEN"],
          [1, "ECP_CS_SENSOR_OPEN"],
          [2, "ECP_CS_SENSOR_FILE_CHARACTERISTICS"]
      ],
      as="FileEcpBitmask_mask",
      separator=", "
    )

  | bitfield:extractFlagsAsString(
      field="FileWrittenFlags",
      flagNames=[
          [0, "HASH_FAILED"],
          [1, "HASH_ABORTED_TOO_LARGE"],
          [2, "PAGING_WRITE"]
      ],
      as="FileWrittenFlags_mask",
      separator=", "
    )

  | case {
      FileCategory = "0"  | FileCategory := "OTHER";
      FileCategory = "1"  | FileCategory := "ARCHIVES";
      FileCategory = "2"  | FileCategory := "OFFICE_DOCUMENTS";
      FileCategory = "3"  | FileCategory := "MULTIMEDIA_FILES";
      FileCategory = "4"  | FileCategory := "DESIGN_FILES";
      FileCategory = "5"  | FileCategory := "SOURCE_CODE";
      FileCategory = "6"  | FileCategory := "EXECUTABLE_FILES";
      FileCategory = "7"  | FileCategory := "VIRTUAL_MACHINE_FILES";
      FileCategory = "8"  | FileCategory := "EMAIL_FILES";
      FileCategory = "9"  | FileCategory := "DATA_AND_LOGS";
      FileCategory = "10" | FileCategory := "ENCRYPTED";
      *
    }
  
  | case {
      IsOnRemovableDisk = "0"  | IsOnRemovableDisk := "No" ;
      IsOnRemovableDisk = "1"  | IsOnRemovableDisk := "Yes" ;
      * 
    }
